<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="%PUBLIC_URL%/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta
      name="description"
      content="Gruju - Connect families and manage children's activities"
    />
    <!-- Cache busting meta tags -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta name="app-version" content="APP_VERSION_PLACEHOLDER" />
    <link rel="apple-touch-icon" href="%PUBLIC_URL%/logo192.png" />
    <link rel="manifest" href="%PUBLIC_URL%/manifest.json" />
    <title>Gruju</title>
    <script>
      // Version-based cache clearing - only clear when version changes
      try {
        const appVersion = document.querySelector('meta[name="app-version"]').content;
        const lastVersion = localStorage.getItem('lastAppVersion');
        
        if (lastVersion !== appVersion) {
          // Preserve important user state during cache clearing
          const userToken = localStorage.getItem('token');
          const userData = localStorage.getItem('userData');
          const forceOnboarding = localStorage.getItem('force_onboarding');
          
          localStorage.clear();
          sessionStorage.clear();
          
          // Restore preserved state
          if (userToken) localStorage.setItem('token', userToken);
          if (userData) localStorage.setItem('userData', userData);
          if (forceOnboarding === 'true') localStorage.setItem('force_onboarding', 'true');
          
          localStorage.setItem('lastAppVersion', appVersion);
        }
      } catch (e) {
        console.log('Version check error:', e);
      }
      
      // Simplified service worker registration
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js')
            .then((registration) => {
              // Check for updates periodically
              setInterval(() => {
                registration.update();
              }, 60000); // Check every minute instead of 30 seconds
            })
            .catch((registrationError) => {
              // Service worker registration failed
            });
        });
        
        // Listen for storage clear messages
        navigator.serviceWorker.addEventListener('message', (event) => {
          if (event.data && event.data.type === 'CLEAR_STORAGE') {
            try {
              localStorage.clear();
              sessionStorage.clear();
            } catch (e) {
              // Error clearing storage
            }
          }
        });
      }
    </script>
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>
    <!--
      This HTML file is a template.
      If you open it directly in the browser, you will see an empty page.

      You can add webfonts, meta tags, or analytics to this file.
      The build step will place the bundled scripts into the <body> tag.

      To begin the development, run `npm start` or `yarn start`.
      To create a production bundle, use `npm run build` or `yarn build`.
    -->
  </body>
</html>
